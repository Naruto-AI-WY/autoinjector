<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://unpkg.com/blockly@10.2.2/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly@10.2.2/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly@10.2.2/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly@10.2.2/msg/zh-hans.js"></script>
    <script src="blocks/serial_blocks.js"></script>
    <script src="blocks/pump_blocks.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #blocklyDiv {
            height: 100%;
            width: 100%;
            position: absolute;
        }
        /* 工具箱样式 */
        .blocklyToolboxDiv {
            font-size: 16px !important;
            padding: 8px;
        }
        .blocklyTreeLabel {
            font-size: 24px !important;
            padding: 4px !important;
        }
        .blocklyTreeRow {
            height: 40px !important;
            line-height: 40px !important;
        }
        /* 高亮显示样式 */
        .blocklyHighlighted > .blocklyPath {
            stroke: #ffeb3b !important;
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 5px rgba(255, 235, 59, 0.5));
        }
    </style>
</head>
<body>
    <div id="blocklyDiv"></div>

    <xml id="toolbox" style="display: none">
        <category name="逻辑" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_boolean"></block>
        </category>

        <category name="循环" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_for">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>

        <category name="数学" colour="%{BKY_MATH_HUE}">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_round"></block>
            <block type="math_constrain">
                <value name="LOW">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="HIGH">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
        </category>

        <category name="变量" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>

        <category name="串口控制" colour="230">
            <block type="serial_port_select"></block>
            <block type="serial_config"></block>
            <block type="device_address"></block>
            <block type="serial_close"></block>
            <block type="serial_save_settings"></block>
        </category>

        <category name="泵控制" colour="210">
            <block type="pump_initialize"></block>
            <block type="pump_set_volume_range">
                <value name="VOLUME">
                    <shadow type="math_number">
                        <field name="NUM">25</field>
                    </shadow>
                </value>
            </block>
            <block type="pump_set_total_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">6000</field>
                    </shadow>
                </value>
            </block>
            <block type="pump_switch_input"></block>
            <block type="pump_switch_output"></block>
            <block type="pump_set_speed">
                <value name="SPEED">
                    <shadow type="math_number">
                        <field name="NUM">500</field>
                    </shadow>
                </value>
            </block>
            <block type="pump_aspirate">
                <value name="VOLUME">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="pump_dispense">
                <value name="VOLUME">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="pump_stop"></block>
            <block type="pump_delay">
                <value name="SECONDS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
        </category>
    </xml>

    <script>
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        var webBridge = null;

        // 刷新串口列表
        async function refreshPortList() {
            console.log("refreshPortList called");
            if (!webBridge || typeof webBridge.getAvailablePorts !== 'function') {
                console.warn('WebBridge or getAvailablePorts not available');
                return;
            }

            try {
                // 获取串口列表 JSON
                const jsonStr = webBridge.getAvailablePorts();
                console.log("Got ports JSON string:", jsonStr);
                
                // 解析 JSON
                const data = JSON.parse(jsonStr);
                if (!data || !data.ports || !Array.isArray(data.ports)) {
                    console.warn("Invalid ports data:", data);
                    return;
                }
                
                const ports = data.ports;
                console.log("Available ports:", ports);
                
                // 更新所有串口选择块
                const blocks = workspace.getAllBlocks(false);
                console.log("Found blocks:", blocks.length);
                blocks.forEach(block => {
                    if (block.type === 'serial_port_select') {
                        console.log("Updating block:", block.id);
                        if (typeof block.updateOptions === 'function') {
                            block.updateOptions(ports);
                        } else {
                            console.warn("Block has no updateOptions method:", block.id);
                        }
                    }
                });
                
                // 刷新工具箱中的块
                const toolbox = workspace.getToolbox();
                if (toolbox) {
                    const category = toolbox.getSelectedItem();
                    if (category) {
                        const flyout = workspace.getFlyout();
                        if (flyout) {
                            // 强制刷新飞出工具箱
                            console.log("Refreshing flyout");
                            flyout.show(category.getContents());
                            
                            // 更新飞出工具箱中的块
                            const flyoutWorkspace = flyout.getWorkspace();
                            const flyoutBlocks = flyoutWorkspace.getAllBlocks(false);
                            console.log("Found flyout blocks:", flyoutBlocks.length);
                            flyoutBlocks.forEach(block => {
                                if (block.type === 'serial_port_select') {
                                    console.log("Updating flyout block:", block.id);
                                    if (typeof block.updateOptions === 'function') {
                                        block.updateOptions(ports);
                                    } else {
                                        console.warn("Flyout block has no updateOptions method:", block.id);
                                    }
                                }
                            });
                        }
                    }
                }
                
            } catch (e) {
                console.error('Failed to refresh ports:', e);
                webBridge.log('Failed to refresh ports: ' + e.toString());
            }
        }

        // 添加保存工作区的函数
        function saveWorkspace() {
            try {
                console.log("开始保存工作区...");
                
                // 获取工作区的所有块
                var xml = Blockly.Xml.workspaceToDom(workspace, true);  // true 表示使用可读格式
                
                // 确保 XML 有正确的命名空间
                xml.setAttribute('xmlns', 'https://developers.google.com/blockly/xml');
                
                // 转换为文本
                var xmlText = Blockly.Xml.domToText(xml);
                
                console.log("XML内容:", xmlText.substring(0, 200) + "...");  // 只显示前200个字符
                webBridge.saveWorkspace(xmlText);
                console.log("工作区保存完成");
            } catch (e) {
                console.error('保存工作区失败:', e);
                if (webBridge) {
                    webBridge.log('保存工作区失败: ' + e.toString());
                }
            }
        }

        // 添加加载工作区的函数
        function loadWorkspace(xmlText) {
            try {
                console.log("开始加载工作区...");
                console.log("XML内容:", xmlText.substring(0, 200) + "...");  // 只显示前200个字符
                
                workspace.clear();  // 清除当前工作区
                
                try {
                    // 尝试直接解析
                    var xml = Blockly.Xml.textToDom(xmlText);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                } catch (parseError) {
                    console.log("直接解析失败，尝试使用 DOMParser:", parseError);
                    
                    // 使用 DOMParser 解析
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    
                    // 检查解析错误
                    var parserError = xmlDoc.getElementsByTagName("parsererror");
                    if (parserError.length) {
                        throw new Error("XML 解析错误: " + parserError[0].textContent);
                    }
                    
                    // 获取根元素
                    var xml = xmlDoc.documentElement;
                    if (!xml) {
                        throw new Error("无法获取 XML 根元素");
                    }
                    
                    // 加载到工作区
                    Blockly.Xml.domToWorkspace(xml, workspace);
                }
                
                console.log("工作区加载完成");
                
                // 触发工作区变化事件
                if (workspace.fireChangeListener) {
                    workspace.fireChangeListener({type: Blockly.Events.FINISHED_LOADING});
                }
                
                return true;
            } catch (e) {
                console.error('加载工作区失败:', e);
                if (webBridge) {
                    webBridge.log('加载工作区失败: ' + e.toString());
                }
                return false;
            }
        }

        // 代码生成事件处理
        function onWorkspaceChange(event) {
            if (event.type == Blockly.Events.FINISHED_LOADING) {
                return;  // 不处理加载事件
            }
            
            // 获取生成的代码
            var code = Blockly.Python.workspaceToCode(workspace);
            // 发送到 Python
            if (typeof webBridge !== 'undefined') {
                webBridge.codeGenerated(code);
            }
        }

        // 添加工作区变化监听器
        workspace.addChangeListener(onWorkspaceChange);

        // 注册 QWebChannel
        new QWebChannel(qt.webChannelTransport, function(channel) {
            window.webBridge = channel.objects.webBridge;
            webBridge = channel.objects.webBridge;
            
            // 监听端口更新
            webBridge.portsUpdated.connect(function() {
                refreshPortList();
            });
        });
    </script>
</body>
</html>
